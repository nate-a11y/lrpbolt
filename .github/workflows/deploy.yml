name: Build & Deploy LRP (beast mode)

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'vite.config.*'
      - 'package.json'
      - 'package-lock.json'
      - 'functions/**'   # still trigger workflow if functions changed; job-level filter will split
      - '.github/workflows/**'
  workflow_dispatch:

concurrency:
  group: lrp-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Ensure package-lock.json
        run: |
          if [ ! -f package-lock.json ]; then
            echo "No package-lock.json found; generating one…"
            npm install --package-lock-only --no-audit --no-fund
          fi

      - name: Validate required secrets
        shell: bash
        env:
          VITE_CALENDAR_API_KEY:             ${{ secrets.VITE_CALENDAR_API_KEY }}
          VITE_CALENDAR_ID:                  ${{ secrets.VITE_CALENDAR_ID }}
          VITE_FIREBASE_API_KEY:             ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN:         ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID:          ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET:      ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID:              ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY:           ${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_FCM_VAPID_KEY:                ${{ secrets.VITE_FCM_VAPID_KEY }}
          VITE_GOOGLE_CLIENT_ID:             ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL:                 ${{ secrets.VITE_API_BASE_URL }}
          VITE_API_SECRET_KEY:               ${{ secrets.VITE_API_SECRET_KEY }}
          VITE_TIME_LOG_CSV:                 ${{ secrets.VITE_TIME_LOG_CSV }}
          VITE_DROP_DAILY_URL:               ${{ secrets.VITE_DROP_DAILY_URL }}
          VITE_SMS_TEST_TO:                  ${{ secrets.VITE_SMS_TEST_TO }}
          VITE_MUI_PRO_KEY:                  ${{ secrets.YOUR_MUI_PRO_KEY }}
          HOSTINGER_FTP_HOST:                ${{ secrets.HOSTINGER_FTP_HOST }}
          HOSTINGER_FTP_USERNAME:            ${{ secrets.HOSTINGER_FTP_USERNAME }}
          HOSTINGER_FTP_PASSWORD:            ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          HOSTINGER_REMOTE_PATH:             ${{ secrets.HOSTINGER_REMOTE_PATH }}
        run: |
          set -euo pipefail
          required=(
            VITE_CALENDAR_API_KEY VITE_CALENDAR_ID
            VITE_FIREBASE_API_KEY VITE_FIREBASE_AUTH_DOMAIN VITE_FIREBASE_PROJECT_ID
            VITE_FIREBASE_STORAGE_BUCKET VITE_FIREBASE_MESSAGING_SENDER_ID VITE_FIREBASE_APP_ID
            VITE_API_BASE_URL VITE_API_SECRET_KEY
            VITE_TIME_LOG_CSV VITE_DROP_DAILY_URL
            VITE_GOOGLE_CLIENT_ID
            HOSTINGER_FTP_HOST HOSTINGER_FTP_USERNAME HOSTINGER_FTP_PASSWORD HOSTINGER_REMOTE_PATH
            VITE_MUI_PRO_KEY
          )
          missing=0
          for k in "${required[@]}"; do
            v="${!k:-}"; if [ -z "$v" ]; then echo "::error::Missing secret $k"; missing=1; fi
          done
          if [ "$missing" -ne 0 ]; then exit 1; fi
          echo "✅ All required secrets present"

      - name: Create .env and .env.production
        run: |
          cat > .env << 'EOF'
          VITE_CALENDAR_API_KEY=${{ secrets.VITE_CALENDAR_API_KEY }}
          VITE_CALENDAR_ID=${{ secrets.VITE_CALENDAR_ID }}
          VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_VAPID_KEY=${{ secrets.VITE_FIREBASE_VAPID_KEY }}
          VITE_FCM_VAPID_KEY=${{ secrets.VITE_FCM_VAPID_KEY }}
          VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          VITE_API_SECRET_KEY=${{ secrets.VITE_API_SECRET_KEY }}
          VITE_TIME_LOG_CSV=${{ secrets.VITE_TIME_LOG_CSV }}
          VITE_DROP_DAILY_URL=${{ secrets.VITE_DROP_DAILY_URL }}
          VITE_SMS_TEST_TO=${{ secrets.VITE_SMS_TEST_TO }}
          VITE_MUI_PRO_KEY=${{ secrets.YOUR_MUI_PRO_KEY }}
          EOF

          cp .env .env.production

      - name: Set build version
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          BASE_VERSION=$(jq -r '.version // "0.0.0"' package.json)
          DATE_TAG=$(date +"%Y%m%d")
          COUNT=${GITHUB_RUN_NUMBER}
          FINAL_VERSION="${BASE_VERSION}-${DATE_TAG}.${COUNT}"
          sed -i '/^VITE_APP_VERSION=/d' .env .env.production 2>/dev/null || true
          echo "VITE_APP_VERSION=$FINAL_VERSION" | tee -a .env .env.production

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: |
          if npm ls eslint --depth=0 >/dev/null 2>&1; then npm run lint --if-present; else echo "Skipping lint"; fi

      - name: Test
        run: |
          if npm ls vitest --depth=0 >/dev/null 2>&1; then npm test; else echo "Skipping tests"; fi

      - name: Build (Vite)
        env:
          MUI_X_LICENSE_KEY: ${{ secrets.YOUR_MUI_PRO_KEY }}
        run: npm run build

      - name: Verify SW files exist
        run: |
          test -f dist/firebase-messaging-sw.js || { echo "::error::dist/firebase-messaging-sw.js missing"; exit 1; }
          test -f dist/manifest.webmanifest || true

      - name: Write Hostinger .htaccess
        run: |
          cat > dist/.htaccess <<'HTACCESS'
          AddType application/javascript .js .mjs
          AddType application/json .json .webmanifest
          AddType text/css .css
          AddType image/png .png
          AddType image/x-icon .ico
          AddType image/svg+xml .svg
          AddType image/webp .webp
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} -f [OR]
          RewriteCond %{REQUEST_FILENAME} -d
          RewriteRule ^ - [L]
          RewriteRule ^(firebase-messaging-sw\.js|sw\.js|service-worker\.js|manifest\.webmanifest|robots\.txt|sitemap\.xml)$ - [L]
          RewriteRule ^icons/ - [L]
          RewriteRule ^assets/ - [L]
          RewriteRule . /index.html [L]
          HTACCESS

      - name: Verify build output
        run: |
          [ -d "dist/assets" ] || { echo "❌ dist/assets missing"; exit 1; }
          ls dist/assets/main-*.js >/dev/null 2>&1 || { echo "❌ main-*.js not found"; exit 1; }
          echo "✅ Build artifacts verified"

      - name: Validate precache/service worker
        run: |
          [ -f dist/sw.js ] || { echo "❌ sw.js missing"; exit 1; }
          echo "✅ Service worker present"

      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: "145.223.77.125"
          username: "u400814892.lakeridepros.xyz"
          password: "m;0C&RhL=AL10b!q"
          protocol: ftp
          local-dir: ./dist/
          server-dir: /public_html/
          log-level: minimal
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/src/*

  functions:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            functions/package-lock.json

      # ---- Skip functions job entirely if nothing changed under functions/ ----
      - name: Determine diff base
        id: base
        run: |
          if git ls-remote --exit-code origin main >/dev/null 2>&1; then
            echo "base_ref=$(git merge-base HEAD origin/main)" >> "$GITHUB_OUTPUT"
          else
            echo "base_ref=$(git rev-parse HEAD^)" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect functions changes
        id: diff
        run: |
          BASE="${{ steps.base.outputs.base_ref }}"
          CHANGED=$(git diff --name-only "$BASE"...HEAD -- functions/ | tr -d '\r')
          if [ -n "$CHANGED" ]; then
            echo "changed=true"  >> "$GITHUB_OUTPUT"
            printf '%s\n' "$CHANGED"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No function changes."
          fi

      - name: Stop if no changes
        if: steps.diff.outputs.changed != 'true'
        run: echo "✅ No changes in functions/ — skipping Functions deploy."

      - name: Write service account key
        if: steps.diff.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.gcloud"
          cat > "$HOME/.gcloud/key.json" <<'JSON'
          ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          JSON
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/.gcloud/key.json" >> "$GITHUB_ENV"
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> "$GITHUB_ENV"

      - name: Install Firebase CLI
        if: steps.diff.outputs.changed == 'true'
        run: npm i -g firebase-tools@14

      - name: Install Functions deps
        if: steps.diff.outputs.changed == 'true'
        working-directory: functions
        run: npm ci

      - name: Set Twilio secrets in Firebase (idempotent)
        if: steps.diff.outputs.changed == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN:  ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM:        ${{ secrets.TWILIO_FROM }}
        run: |
          firebase functions:secrets:set TWILIO_ACCOUNT_SID --project "$FIREBASE_PROJECT_ID" <<< "$TWILIO_ACCOUNT_SID"
          firebase functions:secrets:set TWILIO_AUTH_TOKEN  --project "$FIREBASE_PROJECT_ID" <<< "$TWILIO_AUTH_TOKEN"
          firebase functions:secrets:set TWILIO_FROM        --project "$FIREBASE_PROJECT_ID" <<< "$TWILIO_FROM"

      - name: Deploy Firestore Rules
        if: steps.diff.outputs.changed == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: firebase deploy --only firestore:rules --project "$FIREBASE_PROJECT_ID" --non-interactive

      - name: Deploy Functions (changed functions only)
        if: steps.diff.outputs.changed == 'true'
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: firebase deploy --only functions --project "$FIREBASE_PROJECT_ID" --non-interactive
