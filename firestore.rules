rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function role() {
      return request.auth != null && exists(/databases/$(database)/documents/userAccess/$(lower(request.auth.token.email)))
        ? get(/databases/$(database)/documents/userAccess/$(lower(request.auth.token.email))).data.access
        : "";
    }
    function isAdmin() { return lower(role()) == "admin"; }
    function isDriver() { return lower(role()) == "driver"; }

    match /userAccess/{userId} {
      // Any signed-in user can read the directory
      allow read: if request.auth != null;

      // Only admins can write
      allow create, update, delete: if request.auth != null && isAdmin()
        && request.resource.data.name is string
        && request.resource.data.email is string
        && lower(request.resource.data.access) in ["admin", "driver"];
    }

    match /liveRides/{rideId} {
      allow read: if request.auth != null && (isDriver() || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    match /claimedRides/{rideId} {
      allow read: if request.auth != null && (isDriver() || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

