rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function authed() {
      return request.auth != null && request.auth.token.email is string;
    }
    function lowerEmail() {
      return lower(request.auth.token.email);
    }
    function role() {
      return authed() && exists(/databases/$(database)/documents/userAccess/$(lowerEmail()))
        ? get(/databases/$(database)/documents/userAccess/$(lowerEmail())).data.access
        : "";
    }
    function isAdmin() { return lower(role()) == "admin"; }
    function isDriver() { return lower(role()) == "driver"; }
    function isOwner(data) {
      return data.driverEmail is string && lower(data.driverEmail) == lowerEmail();
    }
    function me() { return authed() ? lowerEmail() : ""; }

    // small validators
    function isStrOrNull(v) { return (v is string) || (v == null); }
    function isTsOrNull(v)  { return (v is timestamp) || (v == null); }
    function isNumOrNull(v) { return (v is number) || (v == null); }

    // tolerate legacy "ClaimedBy"/"ClaimedAt" briefly while code normalizes
    function claimedByLower(d) {
      return lower((d.claimedBy != null ? d.claimedBy :
            (d.ClaimedBy != null ? d.ClaimedBy : "")));
    }
    function claimedAtVal(d) {
      return (d.claimedAt != null ? d.claimedAt :
             (d.ClaimedAt != null ? d.ClaimedAt : null));
    }

    // ---------- userAccess ----------
    // Admins manage; any authed user can read their own
    match /userAccess/{userId} {
      allow read: if authed() && (lower(userId) == lowerEmail() || isAdmin());
      allow create, update, delete: if authed() && isAdmin();
    }

    // userAccessByUid â€“ same idea
    match /userAccessByUid/{uid} {
      allow read: if isAdmin() || (authed() && uid == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // ---------- AdminMeta ----------
    match /AdminMeta/{docId} {
      allow read: if request.auth != null;     // widget reads lastDropDaily
      allow create, update, delete: if false;  // writes occur via Admin SDK in functions
    }

    // ---------- timeLogs ----------
    // App writes: { driverEmail, driver, rideId, startTime, endTime?, duration, loggedAt }
    match /timeLogs/{id} {
      allow read: if authed() && (isAdmin() || isOwner(resource.data));
      allow create: if authed() && (isAdmin() || isOwner(request.resource.data))
        && request.resource.data.driverEmail is string
        && request.resource.data.driver is string
        && request.resource.data.rideId is string
        && request.resource.data.startTime is timestamp
        && isTsOrNull(request.resource.data.endTime)
        && request.resource.data.duration is number
        && request.resource.data.loggedAt is timestamp;
      allow update: if authed() && (isAdmin() || (isOwner(resource.data) && isOwner(request.resource.data)))
        && request.resource.data.driverEmail is string
        && request.resource.data.driver is string
        && request.resource.data.rideId is string
        && request.resource.data.startTime is timestamp
        && isTsOrNull(request.resource.data.endTime)
        && request.resource.data.duration is number
        && request.resource.data.loggedAt is timestamp;
      allow delete: if authed() && isAdmin();
    }

    // ---------- shootoutStats ----------
    // App writes: { driverEmail, vehicle, startTime, endTime?, trips, passengers, createdAt }
    match /shootoutStats/{id} {
      allow read: if authed() && (isAdmin() || isOwner(resource.data));
      allow create: if authed() && (isAdmin() || isOwner(request.resource.data))
        && request.resource.data.driverEmail is string
        && request.resource.data.vehicle is string
        && request.resource.data.startTime is timestamp
        && isTsOrNull(request.resource.data.endTime)
        && isNumOrNull(request.resource.data.trips)
        && isNumOrNull(request.resource.data.passengers)
        && request.resource.data.createdAt is timestamp;
      allow update: if authed() && (isAdmin() || (isOwner(resource.data) && isOwner(request.resource.data)))
        && request.resource.data.driverEmail is string
        && request.resource.data.vehicle is string
        && request.resource.data.startTime is timestamp
        && isTsOrNull(request.resource.data.endTime)
        && isNumOrNull(request.resource.data.trips)
        && isNumOrNull(request.resource.data.passengers)
        && request.resource.data.createdAt is timestamp;
      allow delete: if authed() && isAdmin();
    }

    // ---------- adminLogs ----------
    // Admins only
    match /adminLogs/{id} {
      allow read, create, update, delete: if authed() && isAdmin();
    }

    // ---------- rideQueue ----------
    // Drivers may only claim/unclaim + edit rideNotes; admin full control.
    match /rideQueue/{rideId} {
      function validBase(d) {
        return d.pickupTime is timestamp &&
               isNumOrNull(d.rideDuration) &&
               isStrOrNull(d.rideType) &&
               isStrOrNull(d.vehicle) &&
               isStrOrNull(d.rideNotes) &&
               isStrOrNull(d.claimedBy) || isStrOrNull(d.ClaimedBy) &&
               isTsOrNull(claimedAtVal(d));
      }
      allow read: if authed();
      allow create: if authed() && isAdmin() && validBase(request.resource.data);
      allow delete: if authed() && isAdmin();
      // Drivers may only change {claimedBy|ClaimedBy, claimedAt|ClaimedAt, rideNotes}
      allow update: if authed() && (
        (isAdmin() && validBase(request.resource.data)) ||
        (
          isDriver() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "claimedBy","ClaimedBy","claimedAt","ClaimedAt","rideNotes"
          ]) &&
          validBase(request.resource.data)
        )
      );
    }

    // ---------- claimedRides ----------
    // Created when a driver claims; drivers can edit their own notes; admin full control.
    match /claimedRides/{rideId} {
      function validBase(d) {
        return d.pickupTime is timestamp &&
               isNumOrNull(d.rideDuration) &&
               isStrOrNull(d.rideType) &&
               isStrOrNull(d.vehicle) &&
               isStrOrNull(d.rideNotes) &&
               (claimedByLower(d) != "") &&
               claimedAtVal(d) is timestamp;
      }
      allow read: if authed();
      // Driver can create if they are the claimer; admin can create too
      allow create: if authed() && (
        (isDriver() && claimedByLower(request.resource.data) == me() && validBase(request.resource.data)) ||
        (isAdmin() && validBase(request.resource.data))
      );
      allow delete: if authed() && isAdmin();
      // Driver may only edit rideNotes on their own claimed ride
      allow update: if authed() && (
        (isAdmin() && validBase(request.resource.data)) ||
        (
          isDriver() &&
          claimedByLower(resource.data) == me() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(["rideNotes"]) &&
          validBase(request.resource.data)
        )
      );
    }

    // ---------- liveRides ----------
    // Admin manages queue; drivers can only claim/unclaim + notes.
    match /liveRides/{rideId} {
      function validBase(d) {
        return d.pickupTime is timestamp &&
               isNumOrNull(d.rideDuration) &&
               isStrOrNull(d.rideType) &&
               isStrOrNull(d.vehicle) &&
               isStrOrNull(d.rideNotes) &&
               isStrOrNull(d.claimedBy) || isStrOrNull(d.ClaimedBy) &&
               isTsOrNull(claimedAtVal(d));
      }
      allow read: if authed();
      allow create, delete: if authed() && isAdmin() && validBase(request.resource.data);
      allow update: if authed() && (
        (isAdmin() && validBase(request.resource.data)) ||
        (
          isDriver() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "claimedBy","ClaimedBy","claimedAt","ClaimedAt","rideNotes"
          ]) &&
          validBase(request.resource.data)
        )
      );
    }

    // ---------- tickets ----------
    // Admin creates/edits; drivers only toggle scan fields.
    match /tickets/{ticketId} {
      function validBase(d) {
        return d.pickupTime is timestamp &&
               d.passengercount is number &&
               isStrOrNull(d.ticketId) &&
               isStrOrNull(d.passenger) &&
               isStrOrNull(d.pickup) &&
               isStrOrNull(d.dropoff) &&
               isStrOrNull(d.notes) &&
               (d.scannedOutbound is bool) &&
               (d.scannedReturn is bool) &&
               d.createdAt is timestamp &&
               isTsOrNull(d.scannedOutboundAt) &&
               isStrOrNull(d.scannedOutboundBy) &&
               isTsOrNull(d.scannedReturnAt) &&
               isStrOrNull(d.scannedReturnBy);
      }
      allow read: if authed();
      allow create: if authed() && isAdmin() && validBase(request.resource.data);
      allow delete: if authed() && isAdmin();
      // driver scan-only
      allow update: if authed() && (
        (isAdmin() && validBase(request.resource.data)) ||
        (
          isDriver() &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "scannedOutbound","scannedOutboundAt","scannedOutboundBy",
            "scannedReturn","scannedReturnAt","scannedReturnBy"
          ]) &&
          validBase(request.resource.data)
        )
      );
    }

    // ---------- claimLog / claimFailures ----------
    match /claimLog/{id} {
      allow read: if authed();
      allow create: if authed()
        && request.resource.data.driver is string
        && request.resource.data.tripId is string
        && request.resource.data.timestamp is timestamp;
      allow update, delete: if isAdmin();
    }
    match /claimFailures/{id} {
      allow read: if authed();
      allow create: if authed()
        && request.resource.data.tripId is string
        && request.resource.data.driverName is string
        && request.resource.data.attemptedAt is timestamp
        && request.resource.data.reason is string;
      allow update, delete: if isAdmin();
    }

    // ---------- default deny ----------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
