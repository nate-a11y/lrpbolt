rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Auth & helpers ----------
    function authed() { return request.auth != null; }

    function email() {
      return authed() && request.auth.token.email is string
        ? lower(request.auth.token.email)
        : "";
    }

    function role() {
      return authed() && exists(/databases/$(database)/documents/userAccess/$(email()))
        ? get(/databases/$(database)/documents/userAccess/$(email())).data.access
        : "";
    }

    function isAdmin()  { return authed() && lower(role()) == "admin"; }
    function isDriver() { return authed() && lower(role()) == "driver"; }

    function isOwner(data) {
      return authed()
        && data.driverEmail is string
        && lower(data.driverEmail) == email();
    }

    // small validators
    function isStrOrNull(v) { return (v is string) || (v == null); }
    function isTsOrNull(v)  { return (v is timestamp) || (v == null); }
    function isNumOrNull(v) { return (v is number) || (v == null); }

    // tolerate legacy "ClaimedBy"/"ClaimedAt" while code normalizes
    function claimedByLower(d) {
      return lower((d.claimedBy != null ? d.claimedBy :
            (d.ClaimedBy != null ? d.ClaimedBy : "")));
    }
    function claimedAtVal(d) {
      return (d.claimedAt != null ? d.claimedAt :
             (d.ClaimedAt != null ? d.ClaimedAt : null));
    }

    // ---------- userAccess ----------
    match /userAccess/{userId} {
      allow read: if authed() && (lower(userId) == email() || isAdmin());
      allow create, update, delete: if authed() && isAdmin();
    }

    // userAccessByUid â€“ same idea
    match /userAccessByUid/{uid} {
      allow read: if authed() && (uid == request.auth.uid || isAdmin());
      allow create, update, delete: if authed() && isAdmin();
    }

    // ---------- AdminMeta ----------
    match /AdminMeta/{docId} {
      allow read: if authed();                 // widget reads lastDropDaily etc
      allow create, update, delete: if false;  // writes via Admin SDK only
    }

    // ---------- timeLogs ----------
    match /timeLogs/{id} {
      function allowedKeys() {
        return ['driverEmail','driver','rideId','startTime','endTime','duration','loggedAt','note'];
      }
      function isValid(k, v) {
        return
          (k=='driverEmail' && v is string) ||
          (k=='driver'      && v is string) ||
          (k=='rideId'      && v is string) ||
          (k=='startTime'   && v is timestamp) ||
          (k=='endTime'     && isTsOrNull(v)) ||
          (k=='duration'    && v is number) ||
          (k=='loggedAt'    && v is timestamp) ||
          (k=='note'        && isStrOrNull(v));
      }

      allow read: if authed();

      // Create: minimal "start" fields only
      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.driverEmail is string
        && request.resource.data.driver is string
        && request.resource.data.rideId is string
        && request.resource.data.startTime is timestamp
        && request.resource.data.loggedAt is timestamp
        && !('endTime' in request.resource.data)
        && !('duration' in request.resource.data);

      // Partial-safe update
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- shootoutStats ----------
    match /shootoutStats/{id} {
      function allowedKeys() {
        return ['driverEmail','vehicle','startTime','endTime','trips','passengers','createdAt'];
      }
      function isValid(k, v) {
        return
          (k=='driverEmail' && v is string) ||
          (k=='vehicle'     && v is string) ||
          (k=='startTime'   && v is timestamp) ||
          (k=='endTime'     && isTsOrNull(v)) ||
          (k=='trips'       && (v is number)) ||
          (k=='passengers'  && (v is number)) ||
          (k=='createdAt'   && v is timestamp);
      }

      allow read: if authed();

      // Create: minimal "start" snapshot
      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.driverEmail is string
        && request.resource.data.vehicle is string
        && request.resource.data.startTime is timestamp
        && request.resource.data.createdAt is timestamp
        && (!('trips' in request.resource.data) || request.resource.data.trips is number)
        && (!('passengers' in request.resource.data) || request.resource.data.passengers is number)
        && (!('endTime' in request.resource.data) || request.resource.data.endTime is timestamp);

      // Partial-safe update
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- adminLogs ----------
    match /adminLogs/{id} {
      allow read, create, update, delete: if authed() && isAdmin();
    }

    // ---------- rideQueue ----------
    match /rideQueue/{rideId} {
      function allowedKeys() {
        return [
          'pickupTime','rideDuration','rideType','vehicle','rideNotes',
          'claimedBy','ClaimedBy','claimedAt','ClaimedAt'
        ];
      }
      function isValid(k, v) {
        return
          (k=='pickupTime' && v is timestamp) ||
          (k=='rideDuration' && isNumOrNull(v)) ||
          (k=='rideType' && isStrOrNull(v)) ||
          (k=='vehicle' && isStrOrNull(v)) ||
          (k=='rideNotes' && isStrOrNull(v)) ||
          (k=='claimedBy' && isStrOrNull(v)) ||
          (k=='ClaimedBy' && isStrOrNull(v)) ||
          (k=='claimedAt' && isTsOrNull(v)) ||
          (k=='ClaimedAt' && isTsOrNull(v));
      }

      allow read: if authed();

      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.pickupTime is timestamp;

      // Partial-safe update
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- claimedRides ----------
    match /claimedRides/{rideId} {
      function allowedKeys() {
        return [
          'pickupTime','rideDuration','rideType','vehicle','rideNotes',
          'claimedBy','ClaimedBy','claimedAt','ClaimedAt'
        ];
      }
      function isValid(k, v) {
        return
          (k=='pickupTime' && v is timestamp) ||
          (k=='rideDuration' && isNumOrNull(v)) ||
          (k=='rideType' && isStrOrNull(v)) ||
          (k=='vehicle' && isStrOrNull(v)) ||
          (k=='rideNotes' && isStrOrNull(v)) ||
          (k=='claimedBy' && isStrOrNull(v)) ||
          (k=='ClaimedBy' && isStrOrNull(v)) ||
          (k=='claimedAt' && isTsOrNull(v)) ||
          (k=='ClaimedAt' && isTsOrNull(v));
      }

      allow read: if authed();

      // Require claimedBy/claimedAt on create (legacy keys allowed)
      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.pickupTime is timestamp
        && (
             (request.resource.data.claimedBy is string && request.resource.data.claimedAt is timestamp) ||
             (request.resource.data.ClaimedBy is string && request.resource.data.ClaimedAt is timestamp)
           );

      // Partial-safe update
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- liveRides ----------
    match /liveRides/{rideId} {
      function allowedKeys() {
        return [
          'pickupTime','rideDuration','rideType','vehicle','rideNotes',
          'claimedBy','ClaimedBy','claimedAt','ClaimedAt'
        ];
      }
      function isValid(k, v) {
        return
          (k=='pickupTime' && v is timestamp) ||
          (k=='rideDuration' && isNumOrNull(v)) ||
          (k=='rideType' && isStrOrNull(v)) ||
          (k=='vehicle' && isStrOrNull(v)) ||
          (k=='rideNotes' && isStrOrNull(v)) ||
          (k=='claimedBy' && isStrOrNull(v)) ||
          (k=='ClaimedBy' && isStrOrNull(v)) ||
          (k=='claimedAt' && isTsOrNull(v)) ||
          (k=='ClaimedAt' && isTsOrNull(v));
      }

      allow read: if authed();

      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.pickupTime is timestamp;

      // Partial-safe update
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- tickets ----------
    match /tickets/{ticketId} {
      function allowedKeys() {
        return [
          'pickupTime','passengercount','ticketId','passenger','pickup','dropoff','notes',
          'scannedOutbound','scannedReturn','createdAt',
          'scannedOutboundAt','scannedOutboundBy','scannedReturnAt','scannedReturnBy'
        ];
      }
      function isValid(k, v) {
        return
          (k=='pickupTime'        && v is timestamp) ||
          (k=='passengercount'    && v is number) ||
          (k=='ticketId'          && isStrOrNull(v)) ||
          (k=='passenger'         && isStrOrNull(v)) ||
          (k=='pickup'            && isStrOrNull(v)) ||
          (k=='dropoff'           && isStrOrNull(v)) ||
          (k=='notes'             && isStrOrNull(v)) ||
          (k=='scannedOutbound'   && v is bool) ||
          (k=='scannedReturn'     && v is bool) ||
          (k=='createdAt'         && v is timestamp) ||
          (k=='scannedOutboundAt' && isTsOrNull(v)) ||
          (k=='scannedOutboundBy' && isStrOrNull(v)) ||
          (k=='scannedReturnAt'   && isTsOrNull(v)) ||
          (k=='scannedReturnBy'   && isStrOrNull(v));
      }

      allow read: if authed();

      // Full doc create (strict)
      allow create: if authed()
        && request.resource.data.keys().hasOnly(allowedKeys())
        && request.resource.data.pickupTime is timestamp
        && request.resource.data.passengercount is number
        && request.resource.data.scannedOutbound is bool
        && request.resource.data.scannedReturn is bool
        && request.resource.data.createdAt is timestamp;

      // Partial-safe update (e.g., setting scannedOutbound + scannedOutboundAt/By)
      allow update: if authed()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys())
        && request.resource.data.diff(resource.data).changedKeys()
             .map(k => isValid(k, request.resource.data[k]))
             .hasOnly([true]);

      allow delete: if authed();
    }

    // ---------- claim logs ----------
    match /claimLog/{id} {
      allow read: if authed();
      allow create, update: if authed()
        && request.resource.data.driver is string
        && request.resource.data.tripId is string
        && request.resource.data.timestamp is timestamp;
      allow delete: if authed();
    }

    match /claimFailures/{id} {
      allow read: if authed();
      allow create, update: if authed()
        && request.resource.data.tripId is string
        && request.resource.data.driverName is string
        && request.resource.data.attemptedAt is timestamp
        && request.resource.data.reason is string;
      allow delete: if authed();
    }

    // ---------- default deny ----------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
