<!--
MIT License

Copyright (c) 2025 Lake Ride Pros

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <title>LRP Drift — Boss Mode</title>
    <style>
      :root {
        --lrp-green: #4cbb17;
        --bg: #060606;
        --fg: #e8f5e9;
        --danger: #ff5252;
        --track: #121212;
        --lane: #1f1f1f;
      }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        height: 100%;
        overflow: hidden;
      }
      #root {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        touch-action: none;
        user-select: none;
      }
      .hud {
        position: absolute;
        top: 8px;
        left: 8px;
        right: 8px;
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        letter-spacing: 0.3px;
      }
      .btn {
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--lrp-green);
        color: #000;
        border: none;
        border-radius: 12px;
        padding: 14px 18px;
        font-weight: 800;
        box-shadow: 0 8px 24px rgba(76,187,23,0.35);
        cursor: pointer;
      }
      .btn:active { transform: translateX(-50%) scale(0.98); }
      canvas {
        width: min(96vw, 680px);
        height: min(72vh, 520px);
        border-radius: 16px;
        background: var(--track);
        box-shadow: 0 10px 32px rgba(0,0,0,0.45), inset 0 0 0 1px rgba(255,255,255,0.04);
      }
      .title {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--lrp-green);
      }
      .toast {
        position: absolute;
        top: 44px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(30,30,30,0.9);
        border: 1px solid rgba(255,255,255,0.06);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <div class="hud">
        <div>Score: <span id="score">0</span></div>
        <div>Best: <span id="best">0</span></div>
      </div>
      <div class="title">LRP Drift — Boss Mode</div>
      <div class="toast">Tap / Click & Hold = drift | Release = straighten</div>
      <canvas id="game" width="680" height="520" aria-label="Drift game canvas"></canvas>
      <button id="ctl" class="btn" aria-label="Hold to drift">Hold to Drift</button>
    </div>

    <script>
      // Minimal one-button drift mechanic. Balanced for quick sessions.
      (function () {
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const bestEl = document.getElementById('best');
        const btn = document.getElementById('ctl');

        const W = canvas.width, H = canvas.height;
        let t = 0;
        let running = false;
        let hold = false;
        let score = 0;
        let best = Number(localStorage.getItem('lrp_drift_best') || 0);
        bestEl.textContent = best;

        // Car state
        const car = { x: W * 0.5, y: H * 0.72, vx: 0, vy: 0, angle: 0, speed: 2.2, maxSpeed: 6.2 };
        // Track: a meandering lane, width changes slightly
        let laneCenter = W * 0.5;
        let laneWidth = 220;

        function reset() {
          t = 0; score = 0; laneCenter = W*0.5; laneWidth = 220;
          car.x = W*0.5; car.y = H*0.72; car.vx = 0; car.vy = 0; car.angle = 0; car.speed = 2.2;
          running = true;
        }

        function easeOutQuad(x) { return 1 - (1 - x) * (1 - x); }

        function update() {
          if (!running) return;
          t += 1/60;

          // Difficulty curve
          const diff = Math.min(1, t / 60); // reach cap after ~60s
          car.speed = 2.2 + easeOutQuad(diff) * (car.maxSpeed - 2.2);

          // Lane wobbles
          laneCenter += Math.sin(t * 1.3) * 0.6 + Math.sin(t * 0.37) * 0.3;
          laneWidth = 180 + Math.sin(t * 0.9) * 32;

          // Steering: hold to drift sideways
          const driftForce = hold ? 0.32 + diff * 0.28 : 0.0;
          car.vx += (hold ? (Math.sin(t * 4.2) * driftForce) : -car.vx * 0.08);
          car.vy = -car.speed;

          // Update position
          car.x += car.vx * 6;
          car.y += car.vy;

          // Angle visual
          car.angle = Math.atan2(-car.vy, car.vx) * 0.4;

          // Scroll effect: move track downward by translating canvas
          if (car.y < H * 0.48) {
            const dy = (H * 0.48) - car.y;
            car.y += dy;
          }

          // Scoring
          score += Math.max(1, Math.floor(car.speed));
          scoreEl.textContent = score;

          // Collisions: car must stay within lane
          const dx = car.x - laneCenter;
          const half = laneWidth * 0.5 - 14; // car clearance
          if (Math.abs(dx) > half) {
            gameOver();
          }
        }

        function draw() {
          // BG
          ctx.fillStyle = '#101010';
          ctx.fillRect(0, 0, W, H);

          // Lane
          const gradient = ctx.createLinearGradient(0, 0, 0, H);
          gradient.addColorStop(0, '#1a1a1a');
          gradient.addColorStop(1, '#0f0f0f');
          ctx.fillStyle = gradient;

          ctx.beginPath();
          ctx.moveTo(laneCenter - laneWidth/2, 0);
          ctx.lineTo(laneCenter + laneWidth/2, 0);
          ctx.lineTo(laneCenter + laneWidth/2 + Math.sin(t*0.7)*12, H);
          ctx.lineTo(laneCenter - laneWidth/2 + Math.sin(t*0.7)*12, H);
          ctx.closePath();
          ctx.fill();

          // Lane lines
          ctx.strokeStyle = 'rgba(255,255,255,0.08)';
          ctx.lineWidth = 2;
          for (let y = 0; y < H; y += 28) {
            ctx.beginPath();
            ctx.moveTo(laneCenter - laneWidth/2 + 6, y + (t*20 % 28));
            ctx.lineTo(laneCenter - laneWidth/2 + 6, y + 12 + (t*20 % 28));
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(laneCenter + laneWidth/2 - 6, y + (t*20 % 28));
            ctx.lineTo(laneCenter + laneWidth/2 - 6, y + 12 + (t*20 % 28));
            ctx.stroke();
          }

          // Car (LRP green)
          ctx.save();
          ctx.translate(car.x, car.y);
          ctx.rotate(car.angle);
          ctx.fillStyle = '#4cbb17';
          ctx.strokeStyle = 'rgba(0,0,0,0.6)';
          ctx.lineWidth = 2.5;
          // Body
          ctx.beginPath();
          ctx.roundRect(-18, -10, 36, 20, 6);
          ctx.fill();
          ctx.stroke();
          // Windows
          ctx.fillStyle = '#0b0b0b';
          ctx.fillRect(-10, -7, 20, 7);
          ctx.fillRect(-10, 0, 20, 6);
          // Headlights
          ctx.fillStyle = '#fef4c5';
          ctx.fillRect(16, -6, 2, 4);
          ctx.fillRect(16, 2, 2, 4);
          ctx.restore();
        }

        function loop() {
          update();
          draw();
          if (running) requestAnimationFrame(loop);
        }

        function gameOver() {
          running = false;
          if (score > best) {
            best = score;
            localStorage.setItem('lrp_drift_best', String(best));
            bestEl.textContent = best;
          }
          // Notify parent for Firestore highscores (optional in wrapper)
          try {
            window.parent.postMessage({ type: 'DRIFTBOSS_SCORE', score }, '*');
          } catch (e) { /* noop on cross-origin */ }
          // Show restart button text
          btn.textContent = 'Restart — Hold to Drift';
          btn.style.background = '#ff5252';
          btn.style.color = '#fff';
        }

        function start() {
          btn.textContent = 'Hold to Drift';
          btn.style.background = '#4cbb17';
          btn.style.color = '#000';
          reset();
          requestAnimationFrame(loop);
        }

        // Controls: click / touch hold = drift
        const setHold = (v) => { hold = v; };
        btn.addEventListener('pointerdown', () => setHold(true));
        btn.addEventListener('pointerup', () => setHold(false));
        btn.addEventListener('pointerleave', () => setHold(false));
        btn.addEventListener('click', () => {
          if (!running) start();
        });

        // Also allow anywhere on canvas
        canvas.addEventListener('pointerdown', () => setHold(true));
        canvas.addEventListener('pointerup', () => setHold(false));
        canvas.addEventListener('pointerleave', () => setHold(false));

        // Kick off
        start();
      })();
    </script>
  </body>
</html>
